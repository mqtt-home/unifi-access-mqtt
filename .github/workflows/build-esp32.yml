name: Build and Deploy ESP32 Firmware

on:
  push:
    branches: [main]
    paths:
      - 'esp32/**'
    tags:
      - 'esp32-v*'
  pull_request:
    branches: [main]
    paths:
      - 'esp32/**'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: esp32/unifi-doorbell

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio

      - name: Create default config.h
        run: |
          cat > include/config.h << 'EOF'
          #pragma once
          // Default configuration - configure via web UI after flashing
          EOF

      - name: Install web dependencies
        run: make install-deps

      - name: Build web UI
        run: make build-web

      - name: Build all firmware variants
        run: |
          make build-firmware build-fs ENV=esp32-poe
          make build-firmware build-fs ENV=esp32-s3-zero
          make build-firmware build-fs ENV=esp32-s3-wroom

      - name: Prepare firmware artifacts
        run: |
          mkdir -p docs/firmware/esp32-poe
          mkdir -p docs/firmware/esp32-s3-zero
          mkdir -p docs/firmware/esp32-s3-wroom

          # ESP32-POE
          cp .pio/build/esp32-poe/bootloader.bin docs/firmware/esp32-poe/
          cp .pio/build/esp32-poe/partitions.bin docs/firmware/esp32-poe/
          cp .pio/build/esp32-poe/firmware.bin docs/firmware/esp32-poe/
          cp .pio/build/esp32-poe/littlefs.bin docs/firmware/esp32-poe/
          cp ~/.platformio/packages/framework-arduinoespressif32/tools/partitions/boot_app0.bin docs/firmware/esp32-poe/

          # ESP32-S3-Zero
          cp .pio/build/esp32-s3-zero/bootloader.bin docs/firmware/esp32-s3-zero/
          cp .pio/build/esp32-s3-zero/partitions.bin docs/firmware/esp32-s3-zero/
          cp .pio/build/esp32-s3-zero/firmware.bin docs/firmware/esp32-s3-zero/
          cp .pio/build/esp32-s3-zero/littlefs.bin docs/firmware/esp32-s3-zero/
          cp ~/.platformio/packages/framework-arduinoespressif32/tools/partitions/boot_app0.bin docs/firmware/esp32-s3-zero/

          # ESP32-S3-WROOM
          cp .pio/build/esp32-s3-wroom/bootloader.bin docs/firmware/esp32-s3-wroom/
          cp .pio/build/esp32-s3-wroom/partitions.bin docs/firmware/esp32-s3-wroom/
          cp .pio/build/esp32-s3-wroom/firmware.bin docs/firmware/esp32-s3-wroom/
          cp .pio/build/esp32-s3-wroom/littlefs.bin docs/firmware/esp32-s3-wroom/
          cp ~/.platformio/packages/framework-arduinoespressif32/tools/partitions/boot_app0.bin docs/firmware/esp32-s3-wroom/

          # Prepare release artifacts with unique names
          mkdir -p release
          cp .pio/build/esp32-poe/firmware.bin release/firmware-esp32-poe.bin
          cp .pio/build/esp32-s3-zero/firmware.bin release/firmware-esp32-s3-zero.bin
          cp .pio/build/esp32-s3-wroom/firmware.bin release/firmware-esp32-s3-wroom.bin

      - name: Update manifest versions
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          VERSION=${GITHUB_REF#refs/tags/esp32-v}
          for manifest in docs/manifest-*.json; do
            sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" "$manifest"
          done

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware
          path: esp32/unifi-doorbell/docs/firmware/

      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./esp32/unifi-doorbell/docs
          force_orphan: true

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/esp32-v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            esp32/unifi-doorbell/release/firmware-esp32-poe.bin
            esp32/unifi-doorbell/release/firmware-esp32-s3-zero.bin
            esp32/unifi-doorbell/release/firmware-esp32-s3-wroom.bin
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
